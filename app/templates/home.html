{% extends "base.html" %}
{% set active_page = "home" %}
{% block lead_content %}

<h1>Welcome to Klaxon</h1>

<p class="lead">Organise and lead your online self.</p>
{% endblock %}

{% block main_content %}

{% if user %}
<h1>Your id is: {{ user.id }}</h1>
{% endif %}

<div id="link-tabs-container" class="tabs">
    <div class="row">
    </div>
</div>

<form class="update-link-form">
  <fieldset class="flex two">
    <label><input name="category" type="text" placeholder="Category">Category</label>
    <label><input name="name" type="text" placeholder="Name">Name</label>
    <label><input name="address" type="url" placeholder="http://www.pythonanywhere.com">Address</label>
  </fieldset>
  <button class="update-link-button">Add</button>
</form>


{% endblock %}

{% block page_scripts %}
<script>
/* global $ */

/* TODO: Everywhere we use 'tabid' we should probably be escaping stuff */
function add_category(tabid){
  var tab_source = `<div id="${tabid}-links">
            <h2>${tabid}</h2>
            <ul>
            </ul>
        </div>`;
  $('#link-tabs-container .row').append(tab_source);
  var tab_radio_source = `
    <input id='${tabid}-tab' type='radio' name='tabgroupB' />
    <label class="pseudo button toggle" for="${tabid}-tab">${tabid}</label>
  `;
  /* TODO: This should be before .row I think */
  $('#link-tabs-container .row').before(tab_radio_source);
  $('#link-tabs-container').removeClass('one');
  $('#link-tabs-container').removeClass('two');
  $('#link-tabs-container').removeClass('three');
  var number_tabs = $('#link-tabs-container input[type="radio"]').length;
  var number_class = "zero";
  /* TODO: I'm sure there is a nicer way in Javascript to write this */
  if (number_tabs == 1){
    number_class = "one";
  }
  if (number_tabs == 2){
    number_class = "two";
  }
  if (number_tabs == 3){
    number_class = "three";
  }
  if (number_tabs == 4){
    number_class = "four";
  }
  $('#link-tabs-container').addClass(number_class);

  return $(`#${tabid}-links`);
}


function add_link(tabid, name, href){
    /* TODO: What if the category does not exist? */
    var $tab = $(`#${tabid}-links`);
    if ($tab.length < 1){
      $tab = add_category(tabid);
    }
    $tab.find('ul').append(`<li><a class="${tabid}" href="${href}">${name}</a></li>`);
}

function update_link(e){
    e.preventDefault();
    var $form = $(this).closest('.update-link-form');
    $.ajax({type: "POST",
        url: "{{url_for('add_update_link')}}",
        data: $form.serialize(),
        success: function(data){
          var category = $form.find('input[name="category"]').val();
          var name = $form.find('input[name="name"]').val();
          var address = $form.find('input[name="address"]').val();
          add_link(category, name, address);
        },
        error: function(data){
          alert('Hmm, something failed.');
        }
      });
}


$(document).ready(function(){
    $('.update-link-button').click(update_link);

    {% for link in user.links.all() %}
      add_link('{{link.category}}', '{{link.name}}', '{{link.address}}')
    {% endfor %}

    $('#link-tabs-container input[type="radio"]').first().click();
});
</script>
{% endblock page_scripts%}