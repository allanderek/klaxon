{% extends "base.html" %}
{% set active_page = "home" %}
{% block lead_content %}

<h1>Welcome to Klaxon</h1>

<p class="lead">Organise and lead your online self.</p>
{% endblock %}

{% block main_content %}

{% if user %}
<h1>Your id is: {{ user.id }}</h1>
<a href="{{url_for('logout')}}">Logout</a>
{% endif %}

<div id="link-tabs-container" class="tabs">
    <div class="row">
    </div>
</div>


<label for="add-link" class="button">Add Link</label>

<div class="modal">
  <input id="add-link" type="checkbox" />
  <label for="add-link" class="overlay"></label>
  <form class="update-link-form">
    <div>
      <header>
        <h3>Add Link</h3>
        <label for="add-link" class="close">&times;</label>
      </header>
      <section>
        <fieldset>
          <div class="flex two">
            <label>Category<input name="category" type="text" placeholder="Category"></label>
            <label>Name<input name="name" type="text" placeholder="Name"></label>
          </div>
          <div class="flex one">
            <label>Address<input name="address" type="url" placeholder="http://www.pythonanywhere.com"></label>
          </div>
        </fieldset>
      </section>
      <footer>
        <label for="add-link" class="button update-link-button">Add</label>
        <label for="add-link" class="button dangerous">Cancel</label>
      </footer>
    </div>
  </form>
</div>


{% endblock %}

{% block page_scripts %}
<script>
/* global $ */

function number_string(number){
  switch(number){
    case 1: return 'one';
    case 2: return 'two';
    case 3: return 'three';
    case 4: return 'four';
    case 5: return 'five';
    case 6: return 'six';
    case 7: return 'seven';
    case 8: return 'eight';
    case 9: return 'nine';
    case 10: return 'ten';
    case 11: return 'eleven';
    case 12: return 'twelve';
    default:
      return "";
  }
}

/* TODO: Everywhere we use 'tabid' we should probably be escaping stuff */
function add_category(tabid){
  var tab_source = `<div id="${tabid}-links">
            <h2>${tabid}</h2>
            <div class="flex four link-grid">
            </div>
        </div>`;
  $('#link-tabs-container .row').append(tab_source);
  var tab_radio_source = `
    <input id='${tabid}-tab' type='radio' name='tabgroupB' />
    <label class="pseudo button toggle" for="${tabid}-tab">${tabid}</label>
  `;
  /* TODO: This should be before .row I think */
  $('#link-tabs-container .row').before(tab_radio_source);
  var number_tabs = $('#link-tabs-container input[type="radio"]').length;
  var number_class = number_string(number_tabs)

  $('#link-tabs-container').removeClass();
  $('#link-tabs-container').addClass('tabs');
  $('#link-tabs-container').addClass(number_class);

  return $(`#${tabid}-links`);
}


function delete_link(){
    var $user_link = $(this);
    var link_id = $user_link.attr('link');
    console.log(`Attempting to delete link: ${link_id}`);
    $.ajax({type: "POST",
        url: "{{url_for('delete_link')}}",
        data: { 'link_id': link_id },
        success: function(data){
          $user_link.remove();
        },
        error: function(data){
          alert('Hmm, something failed deleting the link.');
        }
      });
}

function add_link(tabid, name, href, link_id){
    /* TODO: What if the category does not exist? */
    var $tab = $(`#${tabid}-links`);
    if ($tab.length < 1){
      $tab = add_category(tabid);
    }
    var $link_grid = $tab.find('.link-grid');
    var $new_link = $(`
      <div class="user-link" link="${link_id}">
        <a class="${tabid}" href="${href}">${name}</a>
        <label class="delete-link">&times;</label>
      </div>`);
    $link_grid.append($new_link);
    $new_link.click(delete_link);
}

function update_link(e){
    /* Note we are not doing e.preventDefault because it is not a form button
    so the default is not to submit the form anyway. Doing 'e.preventDefault'
    means that the modal does not get hidden. */
    var $form = $(this).closest('.update-link-form');
    $.ajax({type: "POST",
        url: "{{url_for('add_update_link')}}",
        data: $form.serialize(),
        success: function(data){
          var category = $form.find('input[name="category"]').val();
          var name = $form.find('input[name="name"]').val();
          var address = $form.find('input[name="address"]').val();
          add_link(category, name, address, data['link_id']);
        },
        error: function(data){
          alert('Hmm, something failed.');
        }
      });
}


$(document).ready(function(){
    $('.update-link-button').click(update_link);

    {% for link in user.links.all() %}
      add_link('{{link.category}}', '{{link.name}}', '{{link.address}}', {{link.id}});
    {% endfor %}

    $('#link-tabs-container input[type="radio"]').first().click();
});
</script>
{% endblock page_scripts%}